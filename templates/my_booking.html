<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>My Bookings</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

  <style>
    body{
      margin:0;
      font-family: Arial, Helvetica, sans-serif;
      background:#F6F8FC;
      color:#0E1D2D;
    }

    .page{
      width:100%;
      padding:40px 32px;
    }

    .card{
      width:100%;
      max-width:1000px;
      background:#fff;
      border-radius:22px;
      padding:26px;
      box-shadow:0 14px 36px rgba(14,29,45,0.12);
      border:1px solid #E6EBF3;
    }

    h1{ margin:0 0 10px; font-size:28px; }
    h2{ margin:18px 0 10px; font-size:20px; }

    .muted{ color:#546275; font-size:14px; }

    .search-card{
      background:rgba(201,182,255,.14);
      border:1px solid rgba(201,182,255,.45);
      border-radius:16px;
      padding:16px;
      margin-top:12px;
    }

    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }

    @media(max-width:760px){
      .row{ grid-template-columns:1fr; }
    }

    label{
      display:block;
      font-weight:bold;
      font-size:14px;
      margin:10px 0 6px;
    }

    input{
      width:100%;
      padding:12px 14px;
      border-radius:12px;
      border:1px solid #E6EBF3;
      font-size:14px;
    }

    select{
      width:100%;
      padding:12px 14px;
      border-radius:12px;
      border:1px solid #E6EBF3;
      font-size:14px;
      background:#fff;
    }

    .btn{
      padding:12px 14px;
      border-radius:14px;
      font-weight:bold;
      cursor:pointer;
      border:1px solid transparent;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:14px;
    }

    .btn-primary{ background:#4A7A87; color:white; }
    .btn-primary:hover{ background:#2E4D5C; }

    .btn-danger{
      background:rgba(14,29,45,.10);
      border-color:#E6EBF3;
      color:black;
    }

    table{
      width:100%;
      border-collapse:collapse;
      margin-top:12px;
      font-size:14px;
    }

    th{
      background:#F1F4FA;
      text-align:left;
      padding:10px;
      border-bottom:2px solid #E6EBF3;
    }

    td{
      padding:10px;
      border-bottom:1px solid #E6EBF3;
    }

    tr:hover{ background:#FAFBFE; }

    .section{ margin-top:20px; }

    .error{
      color:#b00020;
      font-weight:bold;
      margin-top:10px;
    }

    .footer-actions{
      margin-top:20px;
    }

    /* ===== Filter box (like Admin) ===== */
    .filter-wrap{
      margin-top:12px;
      display:flex;
      justify-content:flex-start;
    }

    .filter-box{
      width:280px;
    }

    @media(max-width:760px){
      .filter-wrap{ justify-content:stretch; }
      .filter-box{ width:100%; }
    }

    .filter-title{
      font-weight:bold;
      font-size:14px;
      margin:0 0 8px;
    }

    .filter-actions{
      margin-top:10px;
      display:flex;
      justify-content:flex-start;
    }

    .btn-apply{
      padding:10px 16px;
      border-radius:14px;
      font-weight:bold;
    }
  </style>
</head>

<body>
 {% include "_navbar.html" %}
<div class="page">
  <div class="card">

    <h1>My Bookings</h1>

    {% if not email and not single_booking %}
      <div class="search-card">
        <form method="GET" action="/my_booking">
          <p class="muted">
            Search by <b>Email</b> (all bookings) or by <b>Booking code</b> (single booking)
          </p>

          <div class="row">
            <div>
              <label>Email</label>
              <input name="email" value="{{ selected_email or '' }}">
            </div>

            <div>
              <label>Booking Code</label>
              <input name="booking_code" value="{{ selected_booking_code or '' }}">
            </div>
          </div>

          {% if error %}
            <div class="error">{{ error }}</div>
          {% endif %}

          <div style="margin-top:14px;">
            <button class="btn btn-primary" type="submit">Search</button>
          </div>
        </form>
      </div>

    {% else %}

      {% if single_booking %}
        <p class="muted">Booking code: <b>#{{ single_booking.booking_code }}</b></p>

        <table>
          <thead>
            <tr>
              <th>Route</th>
              <th>Date & Time</th>
              <th>Seats</th>
              <th>Status</th>
              <th>Total Paid</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>{{ single_booking.Departure_Airport }} → {{ single_booking.Destination_Airport }}</td>
              <td>{{ single_booking.Flight_Date }} {{ single_booking.Departure_Time }}</td>
              <td>{{ single_booking.seats }}</td>
              <td>{{ single_booking.status }}</td>
              <td>{{ single_booking.total_price }}$</td>
            </tr>
          </tbody>
        </table>

      {% else %}
        <p class="muted">Showing bookings for: <b>{{ email }}</b></p>

        <!-- ✅ Filter by status (only for registered), like Admin -->
        {% if is_registered %}
          <div class="filter-wrap">
            <div class="filter-box">
              <div class="filter-title">Filter by status:</div>

              <form method="GET" action="/my_booking">
                <input type="hidden" name="email" value="{{ email }}">

                {#  ✅ FIX: אם all_statuses הגיע ריק בטעות, נבנה רשימה מהנתונים שכבר יש בעמוד  #}
                {% set tmp = [] %}
                {% for b in upcoming %}
                  {% if b.status and (b.status not in tmp) %}
                    {% set _ = tmp.append(b.status) %}
                  {% endif %}
                {% endfor %}
                {% for b in history %}
                  {% if b.status and (b.status not in tmp) %}
                    {% set _ = tmp.append(b.status) %}
                  {% endif %}
                {% endfor %}

                {% set statuses_to_show = all_statuses if (all_statuses is defined and all_statuses|length > 0) else tmp %}

                <select name="status">
                  <option value="" {% if not selected_status %}selected{% endif %}>All</option>
                  {% for st in statuses_to_show %}
                    <option value="{{ st }}" {% if selected_status == st %}selected{% endif %}>{{ st }}</option>
                  {% endfor %}
                </select>

                <div class="filter-actions">
                  <button class="btn btn-primary btn-apply" type="submit">Apply</button>
                </div>
              </form>
            </div>
          </div>
        {% endif %}

        <div class="section">
          <h2>Upcoming flights</h2>
          {% if upcoming|length == 0 %}
            <p class="muted">No upcoming flights.</p>
          {% else %}
            <table>
              <thead>
                <tr>
                  <th>Booking</th>
                  <th>Route</th>
                  <th>Date & Time</th>
                  <th>Seats</th>
                  <th>Status</th>
                  <th>Total</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                {% for b in upcoming %}
                <tr>
                  <td>#{{ b.booking_code }}</td>
                  <td>{{ b.Departure_Airport }} → {{ b.Destination_Airport }}</td>
                  <td>{{ b.Flight_Date }} {{ b.Departure_Time }}</td>
                  <td>{{ b.seats }}</td>
                  <td>{{ b.status }}</td>
                  <td>{{ b.total_price }}$</td>
                  <td>
                    {% set st = (b.status or '')|lower %}
                    {% if 'cancel' in st %}
                      —
                    {% else %}
                      <!-- ✅ שינוי קריטי: לא מעבירים email לביטול, רק booking_code -->
                      <form method="POST" action="/booking/cancel">
  <input type="hidden" name="booking_code" value="{{ b.booking_code }}">
  <input type="hidden" name="email" value="{{ email }}">
  <button class="btn btn-danger" type="submit">Cancel</button>
</form>

                    {% endif %}
                  </td>

                </tr>
                {% endfor %}
              </tbody>
            </table>
          {% endif %}
        </div>

    {% if is_registered %}
        <div class="section">
          <h2>History</h2>
          {% if history|length == 0 %}
            <p class="muted">No history.</p>
          {% else %}
            <table>
              <thead>
                <tr>
                  <th>Booking</th>
                  <th>Route</th>
                  <th>Date & Time</th>
                  <th>Seats</th>
                  <th>Status</th>
                  <th>Total</th>
                </tr>
              </thead>
              <tbody>
                {% for b in history %}
                <tr>
                  <td>#{{ b.booking_code }}</td>
                  <td>{{ b.Departure_Airport }} → {{ b.Destination_Airport }}</td>
                  <td>{{ b.Flight_Date }} {{ b.Departure_Time }}</td>
                  <td>{{ b.seats }}</td>
                  <td>{{ b.status }}</td>
                  <td>{{ b.total_price }}$</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          {% endif %}
        </div>

      {% endif %}
    {% endif %}
{% endif %}

    <div class="footer-actions">
      <a class="btn" href="/session/clear">Back</a>
    </div>

  </div>
</div>
</body>
</html>
