<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Select Seats</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

  <style>
    body{
      margin:0;
      font-family: Arial, Helvetica, sans-serif;
      background:#F6F8FC;
      color:#0E1D2D;
    }

    .page{
      width:100%;
      max-width:none;
      padding:40px 32px;
    }

    .card{
      width:100%;
      max-width:800px;
      background:#fff;
      border-radius:22px;
      padding:26px;
      box-shadow:0 14px 36px rgba(14,29,45,0.12);
      border:1px solid #E6EBF3;
    }

    h1{
      margin:0 0 12px;
      font-size:28px;
    }

    h2{
      margin:0 0 10px;
      font-size:18px;
    }

    .muted{
      color:#546275;
      font-size:14px;
    }

    .summary{
      background:rgba(201,182,255,.14);
      border:1px solid rgba(201,182,255,.45);
      border-radius:16px;
      padding:14px;
      margin: 10px 0 16px;
    }

    .summary .row{
      margin:6px 0;
      font-size:14px;
    }

    .warning{
      margin-top:10px;
      background:rgba(201,182,255,.25);
      border:1px solid rgba(201,182,255,.6);
      color:#0E1D2D;
      padding:10px 12px;
      border-radius:14px;
      font-weight:bold;
      font-size:14px;
    }

    .email-row{
      margin: 10px 0 14px;
      display:flex;
      gap:12px;
      align-items:center;
      flex-wrap:wrap;
    }

    label{
      display:block;
      font-weight:bold;
      font-size:14px;
      margin:10px 0 6px;
    }

    input{
      padding:12px 14px;
      border-radius:12px;
      border:1px solid #E6EBF3;
      font-size:14px;
      box-sizing:border-box;
      width:100%;
      max-width:420px;
    }

    input:focus{
      outline:none;
      border-color:#6F5BFF;
      box-shadow:0 0 0 3px rgba(201,182,255,0.5);
    }

    .selected-box{
      margin: 12px 0 16px;
      padding:12px 14px;
      border-radius:16px;
      border:1px solid #E6EBF3;
      background:#FAFBFE;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    .selected-box b{
      white-space:nowrap;
    }

    #selected_text{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      color:#0E1D2D;
    }

    .section{
      margin: 18px 0;
      padding: 16px;
      border: 1px solid #E6EBF3;
      border-radius:18px;
      background:#fff;
    }

    table.seat-grid{
      border-collapse:collapse;
      margin-top:10px;
      width:100%;
      font-size:14px;
    }

    table.seat-grid th, table.seat-grid td{
      border:1px solid #E6EBF3;
      padding:8px;
      text-align:center;
      vertical-align:middle;
    }

    .rownum{
      font-weight:bold;
      background:#F1F4FA;
      width:70px;
      white-space:nowrap;
    }

    .seat-btn{
      min-width:54px;
      height:36px;
      border-radius:10px;
      border:1px solid #E6EBF3;
      cursor:pointer;
      font-weight:bold;
      background:#fff;
      color: #0E1D2D;   /* ✅ טקסט שחור */
    }


    /* hover רק על מושב זמין שעדיין לא נבחר */
    .seat-btn.available:not(.selected):hover{
      background: rgba(201,182,255,0.45);   /* לילך בהיר */
      border-color: #C9B6FF;
      color: #0E1D2D;                       /* טקסט שחור */
    }


    .seat-btn.sold{
      background:#CBD5E1;
      color:#546275;
      cursor:not-allowed;
      border-color:#CBD5E1;
    }

    .seat-btn.selected{
        background: #4A7A87;                  /* ירוק-טורקיז של האתר */
        border-color: #4A7A87;
        color: #FFFFFF;
    }

    .actions{
      margin-top:16px;
      display:flex;
      gap:12px;
      align-items:center;
      flex-wrap:wrap;
    }

    .btn{
      padding:12px 14px;
      border-radius:14px;
      font-weight:bold;
      cursor:pointer;
      border:1px solid transparent;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:14px;
    }

    .btn-primary{
      background:#4A7A87;
      color:white;
    }

    .btn-primary:hover{
      background:#2E4D5C;
    }

    .btn-ghost{
      background:white;
      color:#0E1D2D;
      border-color:#E6EBF3;
    }

    .btn-ghost:hover{
      background:rgba(201,182,255,.18);
    }

    @media(max-width:700px){
      table.seat-grid th, table.seat-grid td{ padding:6px; }
      .seat-btn{ min-width:48px; }
    }
  </style>
</head>

<body>
<div class="page">
  <div class="card">
    <h1>Select Seats</h1>

    <div class="summary">
      <div class="row">
        <b>Flight:</b> {{ flight_date }} {{ departure_time }} | {{ flight.Departure_Airport }} → {{ flight.Destination_Airport }}
      </div>

      <!-- ✅ הודעה גם מהשרת וגם מה-JS -->
      <div id="warning_box" class="warning" style="{% if not message %}display:none;{% endif %}">
        {{ message or "" }}
      </div>
    </div>

    <form id="seatForm" method="POST" action="/order/preview">
      <input type="hidden" name="flight_date" value="{{ flight_date }}">
      <input type="hidden" name="departure_time" value="{{ departure_time }}">
      <input type="hidden" id="selected_seats" name="selected_seats" value="">

      {% if not session.get("username") %}
        <div class="email-row">
          <div style="width:100%; max-width:420px;">
            <label>Your email</label>
            <input type="email" name="guest_email" placeholder="Your email" required>
          </div>
        </div>
      {% endif %}

      <div class="selected-box">
        <b>Selected:</b> <span id="selected_text">(none)</span>
      </div>

      {% for sec in sections %}
        <div class="section">
          <h2>{{ sec.class_type }}</h2>

          <table class="seat-grid">
            <thead>
              <tr>
                <th class="rownum">Row</th>
                {% for L in sec.col_labels %}
                  <th>{{ L }}</th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
            {% for r in sec.grid %}
              <tr>
                <td class="rownum">{{ r.row }}</td>
                {% for s in r.seats %}
                  <td>
                    {% if s.sold %}
                      <button type="button"
                              class="seat-btn sold"
                              disabled
                              title="Sold">{{ s.row }}{{ s.label }}</button>
                    {% else %}
                      <button type="button"
                              class="seat-btn available"
                              data-seat="{{ s.row }}{{ s.label }}"
                              title="Available">{{ s.row }}{{ s.label }}</button>
                    {% endif %}
                  </td>
                {% endfor %}
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>
      {% endfor %}

      <div class="actions">
        <button class="btn btn-primary" type="submit">Continue → Create order</button>
        <a class="btn btn-ghost" href="/flights">Back to flights</a>
      </div>
    </form>
  </div>
</div>

<script>
  const selected = new Set();
  const hidden = document.getElementById("selected_seats");
  const txt = document.getElementById("selected_text");
  const form = document.getElementById("seatForm");
  const warningBox = document.getElementById("warning_box");

  function showWarning(msg){
    warningBox.textContent = msg;
    warningBox.style.display = "block";
    warningBox.scrollIntoView({ behavior: "smooth", block: "nearest" });
  }

  function hideWarning(){
    warningBox.textContent = "";
    warningBox.style.display = "none";
  }

  function refreshSelected(){
    const arr = Array.from(selected);
    hidden.value = arr.join(",");
    txt.textContent = arr.length ? arr.join(", ") : "(none)";
  }

  document.querySelectorAll(".seat-btn.available").forEach(btn => {
    btn.addEventListener("click", () => {
      const seat = btn.dataset.seat;
      if (selected.has(seat)) {
        selected.delete(seat);
        btn.classList.remove("selected");
      } else {
        selected.add(seat);
        btn.classList.add("selected");
      }
      refreshSelected();
      if (selected.size > 0) hideWarning();
    });
  });

  // ✅ חובה לבחור לפחות מושב אחד
  form.addEventListener("submit", function(e){
    if (selected.size === 0){
      e.preventDefault();
      showWarning("You must select at least one seat before continuing.");
    }
  });

  refreshSelected();
</script>
</body>
</html>
